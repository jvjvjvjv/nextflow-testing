// nextflow.config

params {
    output_dir = './output'
    num_replicates = 10
}

process {
    maxRetries = 2
    container = 'amancevice/pandas:latest'
}

profiles {
     // Personal computer
    local {
        process {
            executor = 'local'
        }
        docker {
            enabled = true
            runOptions = "-v ${projectDir}:${projectDir}"
        }
    }

    // Unity
    unity {
        // Use slurm with default resource limits (taken from Unity nf-core profile)
        process {
            executor = 'slurm'

            resourceLimits = [
                cpus: 192,
                memory: 2.TB,
                time: 14.d
            ]

            // Selects partition based on process time
            queue = { task.time <= 2.h ? 'cpu-preempt' : 'cpu' }
            clusterOptions = { "${task.time >= 48.h ? '-q long --nodes 1' : '--nodes 1'}" }
        }

        // Limits job submission to 1000 consecutive run and 20 submissions per second
        executor {
            queueSize = 1000
            submitRateLimit = '20sec'
            pollInterval = '30sec'
            queueStatInterval = '1min'
        }

        // Enables apptainer
        apptainer {
            enabled = true
            autoMounts = true
            pullTimeout = '120m'
            runOptions = "-B ${projectDir}/lib"
        }
    }

    // Harmony
    harmony {
        process {
            executor = "k8s"
        }
        docker {
            enabled = true
        }
        k8s {
            enabled = true
            serviceAccount = 'nextflow-sa'
            storaceClaimName = 'nextflow-pvc'
            // storageMountPath = '/workspace'
            // projectDir = '/mnt/nextflow'
            // workDir = '/mnt/nextflow/work'
            pod = [[volumeClaim: 'nextflow-pvc', mountPath: '/workspace']]
            imagePullPolicy = 'IfNotPresent'
            namespace = 'nf-shard'
            computeResourceType = 'Job'
            debug {
                yaml = true
            }
            cleanup = true
        }
    }

    shard {
        tower {
            enabled = true
            accessToken = "x"
            endpoint = "http://nf-shard:3000/api"
            workspaceId = "1"
        }
    }
}

// clean the generated files in the working directory
cleanup = true
